<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="expert" >
  <resultMap id="BaseResultMap" type="java.util.HashMap" ></resultMap>
  <parameterMap id="BaseParameterMap" type="java.util.HashMap" ></parameterMap>
  <!-- 查询当前评审专家需要审核的数据 -->
  <select id="findExpertCheckList" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
 	select
 		x.EXPLORE_EXPERT_PK,
 		x.EXPERT_STATUS,
	 	e.STATUS,
		e.SC_EXPLORE_PK,
	    p.EXPLORE_PETITION_PK,
		p.PROJECT_TITLE,
		p.PROJECT_TYPE,
		p.PROJECT_RESOURCE,
		p.FK_TEACHER,
		p.TEACHER_NAME,
		p.TEACHER_TEL,
		p.FK_TEACHER_SCHOOL,
		p.TEACHER_SCHOOL_NAME,
		p.TEACHER_SCHOOL_TEL,
		p.TEACHER_SCHOOL_ADDRESS,
		p.TEACHER_SCHOOL_POSTAL,
		p.PRICE,
		to_char(p.APPLY_DATE,'yyyy-MM-dd') APPLY_DATE,
		to_char(p.FINISH_DATE,'yyyy-MM-dd') FINISH_DATE,
		p.TOPIC_NAME,
		p.TEACHER_JOB,
		p.TEACHER_JOB_TITLE,
		p.TEACHER_HOME_TEL,
		p.BASIS_THEORY,
		p.PLANS,
		p.CONDITION,
		p.APPLY_CODE,
		p.PROJECT_CODE,
		p.TEACHER_EMAIL,
		p.INFORMATION_REVIEW,
		p.DESIGN_ARGUMENT,
		p.TEACHER_SKILL,
		p.TEACHER_IDCARD,
		p.EXPECT_RESULT,
		p.PROJECT_LEVEL,
		p.SCHOOL_CHECK_OPINION,
		p.AREA_CHECK_OPINION,
		p.SCHOOL_CHECK_RESULT,
		p.AREA_CHECK_RESULT,
		p.FINANCE_MONEY,
		ROUND(TO_NUMBER((p.FINISH_DATE+0)-sysdate)) as DELTA_TIME
	 from SC_EXPLORE e,SC_EXPLORE_PETITION p
	 ,SC_EXPLORE_EXPERT x
	 where e.FK_EXPLORE_PETITION=p.EXPLORE_PETITION_PK
	 and e.SC_EXPLORE_PK=x.FK_EXPLORE
	 and x.FK_EXPERT_TEACHER=#{userInfo.GUID}
	 and e.STATUS in(3,17)
   	 <if test=" PROJECT_TITLE!= null and  PROJECT_TITLE!='' ">
  			and PROJECT_TITLE LIKE '%'||#{PROJECT_TITLE}||'%'
  	 </if>
 </select>
  
  <select id="findExpertCheckListSize" parameterMap="BaseParameterMap" resultType="java.lang.Integer">
 	select
  	 	count(*)
	 from SC_EXPLORE e,SC_EXPLORE_PETITION p,SC_EXPLORE_EXPERT x
	 where e.FK_EXPLORE_PETITION=p.EXPLORE_PETITION_PK
	 and e.SC_EXPLORE_PK=x.FK_EXPLORE
	 and x.FK_EXPERT_TEACHER=#{userInfo.GUID}
	 and e.STATUS in(3,17)
   	 <if test=" PROJECT_TITLE!= null and  PROJECT_TITLE!='' ">
  			and PROJECT_TITLE LIKE '%'||#{PROJECT_TITLE}||'%'
  	 </if>
  </select>
  <!--查询专家评审信息  -->
  <select id="findExpertCheckById" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
  	select
  		x.EXPLORE_EXPERT_PK,
 		x.EXPERT_STATUS,
 		x.EXPERT_OPTION,
 		x.EXPERT_MARK,
  		e.SC_EXPLORE_PK,
	 	e.STATUS,
		e.FK_EXPLORE_REPORT,
		e.FK_EXPLORE_PROGRESS,
		e.FK_PROJECT_ACHIEVE,
	    p.EXPLORE_PETITION_PK,
		p.PROJECT_TITLE,
		p.PROJECT_TYPE,
		p.PROJECT_RESOURCE,
		p.FK_TEACHER,
		p.TEACHER_NAME,
		p.TEACHER_GENDER,
		p.TEACHER_TEL,
		p.FK_TEACHER_SCHOOL,
		p.TEACHER_SCHOOL_NAME,
		p.TEACHER_SCHOOL_TEL,
		p.TEACHER_SCHOOL_ADDRESS,
		p.TEACHER_SCHOOL_POSTAL,
		p.PRICE,
		to_char(p.APPLY_DATE,'yyyy-MM-dd') APPLY_DATE,
		to_char(p.FINISH_DATE,'yyyy-MM-dd') FINISH_DATE,
		p.TOPIC_NAME,
		p.TEACHER_JOB,
		p.TEACHER_JOB_TITLE,
		p.TEACHER_HOME_TEL,
		p.BASIS_THEORY,
		p.PLANS,
		p.CONDITION,
		p.APPLY_CODE,
		p.PROJECT_CODE,
		p.TEACHER_EMAIL,
		p.INFORMATION_REVIEW,
		p.DESIGN_ARGUMENT,
		p.TEACHER_SKILL,
		p.TEACHER_IDCARD,
		p.EXPECT_RESULT,
		p.PROJECT_LEVEL,
		p.SCHOOL_CHECK_OPINION,
		p.SCHOOL_CHECK_RESULT,
		to_char(p.SCHOOL_CHECK_TIME,'yyyy-MM-dd') SCHOOL_CHECK_TIME,
		to_char(p.AREA_CHECK_TIME,'yyyy-MM-dd') AREA_CHECK_TIME,
		(select USER_SN from SC_CORE.SC_USER where USER_PK=p.SCHOOL_CHECK_USER) SCHOOL_CHECK_USER,
		(select USER_SN from SC_CORE.SC_USER where USER_PK=p.AREA_CHECK_USER) AREA_CHECK_USER,
		p.AREA_CHECK_OPINION,
		p.AREA_CHECK_RESULT,
		p.FINANCE_MONEY
		from SC_EXPLORE e,SC_EXPLORE_PETITION p,SC_EXPLORE_EXPERT x
	 where e.FK_EXPLORE_PETITION=p.EXPLORE_PETITION_PK
	 and e.SC_EXPLORE_PK=x.FK_EXPLORE
	 and x.EXPLORE_EXPERT_PK=#{EXPLORE_EXPERT_PK}
  </select>
  
  <!-- 通过科研主键查询开题报告 -->
 		<select id="findExpertAchieveById" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
	 	select
	 		x.EXPLORE_EXPERT_PK,
	 		x.EXPERT_STATUS,
	 		x.EXPERT_OPTION,
	 		x.EXPERT_MARK,
	  		e.SC_EXPLORE_PK,
		 	e.STATUS,
		 	e.FK_EXPLORE_PETITION,
		 	e.FK_EXPLORE_REPORT,
			e.FK_EXPLORE_PROGRESS,
		   	a.EXPLORE_ACHIEVE_PK,
			a.USER_WORK,
			a.PUBLISH_TITLE,
			a.PUBLISH_SORT,
			a.PERIODICALS_FLAG,
			a.PERIODICALS_NAME,
			to_char(a.PERIODICALS_DATE,'yyyy-MM-dd') PERIODICALS_DATE,
			a.PERIODICALS_NUMBER,
			a.WORK_DESCRIBE,
			a.FINAL_REPORT,
			to_char(a.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME,
			a.SCHOOL_CHECK_OPINION,
			a.AREA_CHECK_OPINION,
			a.SCHOOL_CHECK_RESULT,
			a.AREA_CHECK_RESULT,
			to_char(a.SCHOOL_CHECK_TIME,'yyyy-MM-dd') SCHOOL_CHECK_TIME,
			to_char(a.AREA_CHECK_TIME,'yyyy-MM-dd') AREA_CHECK_TIME,
			(select USER_SN from SC_CORE.SC_USER where USER_PK=a.SCHOOL_CHECK_USER) SCHOOL_CHECK_USER,
			(select USER_SN from SC_CORE.SC_USER where USER_PK=a.AREA_CHECK_USER) AREA_CHECK_USER,
			a.EXPERT_RESULT_OPINION
			from SC_EXPLORE_ACHIEVE a,SC_EXPLORE e,SC_EXPLORE_EXPERT x
		 where a.EXPLORE_ACHIEVE_PK=e.FK_PROJECT_ACHIEVE
	     and e.SC_EXPLORE_PK=x.FK_EXPLORE
	 	 and x.EXPLORE_EXPERT_PK=#{EXPLORE_EXPERT_PK}
	 	</select>
  
    <!-- 申请书专家审核详情 -->
 	<select id="findExpertCheckInfo" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
	select 
		EXPLORE_EXPERT_PK,
		FK_EXPLORE,
		EXPERT_OPTION,
		FK_EXPERT_TEACHER,
		EXPERT_MARK,
		to_char(EXPERT_DATE,'yyyy-MM-dd') EXPERT_DATE,
		EXPERT_LEVEL,
		EXPERT_TEACHER_NAME,
		EXPERT_STATUS
	from SC_EXPLORE_EXPERT
	where FK_EXPLORE=#{EXPLORE_PK}
	and EXPERT_LEVEL=1
</select>
  
  <!-- 结题报告专家审核详情 -->
 	<select id="findAchieveCheckInfo" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
	select 
		EXPLORE_EXPERT_PK,
		FK_EXPLORE,
		EXPERT_OPTION,
		FK_EXPERT_TEACHER,
		EXPERT_MARK,
		to_char(EXPERT_DATE,'yyyy-MM-dd') EXPERT_DATE,
		EXPERT_LEVEL,
		EXPERT_TEACHER_NAME,
		EXPERT_STATUS
	from SC_EXPLORE_EXPERT
	where FK_EXPLORE=#{EXPLORE_PK}
	and EXPERT_LEVEL=2
</select>
  
   <!-- 申请书专家审核 -->
	 <update id="expertCheckApply" parameterMap="BaseParameterMap">
  		update SC_EXPLORE_EXPERT
			set 
				EXPERT_MARK=#{EXPERT_MARK},
				EXPERT_STATUS=1,
		  		EXPERT_DATE=sysdate
		  		<if test="EXPERT_OPTION != null and EXPERT_OPTION !='' ">
		  			,
		  			EXPERT_OPTION=#{EXPERT_OPTION}
		  		</if>
		where FK_EXPLORE=#{SC_EXPLORE_PK} 
		and EXPERT_LEVEL=#{EXPERT_LEVEL}
		and FK_EXPERT_TEACHER=#{userInfo.GUID}
  	</update>
  <!--  结题报告专家审核-->
  <update id="expertCheckAchieve" parameterMap="BaseParameterMap">
  		update SC_EXPLORE_EXPERT
			set 
				EXPERT_MARK=#{EXPERT_MARK},
				EXPERT_STATUS=1,
		  		EXPERT_DATE=sysdate
		  		<if test="EXPERT_OPTION != null and EXPERT_OPTION !='' ">
		  			,
		  			EXPERT_OPTION=#{EXPERT_OPTION}
		  		</if>
		where FK_EXPLORE=#{SC_EXPLORE_PK} 
		and EXPERT_LEVEL=#{EXPERT_LEVEL}
		and FK_EXPERT_TEACHER=#{userInfo.GUID}
  	</update>
</mapper>