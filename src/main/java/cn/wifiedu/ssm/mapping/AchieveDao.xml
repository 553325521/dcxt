<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="achieve" >
  <resultMap id="BaseResultMap" type="java.util.HashMap" ></resultMap>
  <parameterMap id="BaseParameterMap" type="java.util.HashMap" ></parameterMap>	
 		<!-- 通过科研主键查询开题报告 -->
 		<select id="findAchieveById" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
	 	select
	  		e.SC_EXPLORE_PK,
		 	e.STATUS,
		 	e.FK_EXPLORE_PETITION,
		 	e.FK_EXPLORE_REPORT,
			e.FK_EXPLORE_PROGRESS,
		   	a.EXPLORE_ACHIEVE_PK,
			a.USER_WORK,
			a.PUBLISH_TITLE,
			a.PUBLISH_SORT,
			a.PERIODICALS_FLAG,
			a.PERIODICALS_NAME,
			to_char(a.PERIODICALS_DATE,'yyyy-MM-dd') PERIODICALS_DATE,
			a.PERIODICALS_NUMBER,
			a.WORK_DESCRIBE,
			a.FINAL_REPORT,
			to_char(a.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME,
			a.SCHOOL_CHECK_OPINION,
			a.AREA_CHECK_OPINION,
			a.SCHOOL_CHECK_RESULT,
			a.AREA_CHECK_RESULT,
			to_char(a.SCHOOL_CHECK_TIME,'yyyy-MM-dd') SCHOOL_CHECK_TIME,
			to_char(a.AREA_CHECK_TIME,'yyyy-MM-dd') AREA_CHECK_TIME,
			(select USER_SN from SC_CORE.SC_USER where USER_PK=a.SCHOOL_CHECK_USER) SCHOOL_CHECK_USER,
			(select USER_SN from SC_CORE.SC_USER where USER_PK=a.AREA_CHECK_USER) AREA_CHECK_USER,
			a.EXPERT_RESULT_OPINION,
			a.RES_FILE_LINK_PK,
			a.FILE_NAME,
			a.EXT_NAME,
			a.FILE_PATH,
			a.FILE_ID
			from SC_EXPLORE_ACHIEVE a,SC_EXPLORE e
		 where a.EXPLORE_ACHIEVE_PK=e.FK_PROJECT_ACHIEVE
	     and e.SC_EXPLORE_PK=#{SC_EXPLORE_PK}
	 	</select>
 
 		<!-- 添加结题报告 -->
 		<insert id="insertAchieve" parameterMap="BaseParameterMap">
 			insert into SC_EXPLORE_ACHIEVE
 				(	
					EXPLORE_ACHIEVE_PK,
					USER_WORK,
					PUBLISH_TITLE,
					PUBLISH_SORT,
					PERIODICALS_FLAG,
					PERIODICALS_NAME,
					<if test="PERIODICALS_DATE != null and PERIODICALS_DATE !='' ">
		  			PERIODICALS_DATE,
		  		    </if>
					PERIODICALS_NUMBER,
					WORK_DESCRIBE,
					FINAL_REPORT,
					CREATE_TIME,
					RES_FILE_LINK_PK,
					FILE_NAME,
					EXT_NAME,
					FILE_PATH,
					FILE_ID,
					SCHOOL_CHECK_RESULT,
					AREA_CHECK_RESULT	
 				)
 			values
 				(
 					#{UUID},
 					#{USER_WORK},
 					#{PUBLISH_TITLE},
 					#{PUBLISH_SORT},
 					#{PERIODICALS_FLAG},
 					#{PERIODICALS_NAME,jdbcType=VARCHAR},
 					<if test="PERIODICALS_DATE != null and PERIODICALS_DATE !='' ">
		  			to_date(#{PERIODICALS_DATE},'yyyy-MM-dd'),
		  		    </if>
 					#{PERIODICALS_NUMBER,jdbcType=VARCHAR},
 					#{WORK_DESCRIBE},
 					#{FINAL_REPORT},
 					sysdate,
 					#{RES_FILE_LINK_PK,jdbcType=VARCHAR},
					#{FILE_NAME,jdbcType=VARCHAR},
					#{EXT_NAME,jdbcType=VARCHAR},
					#{FILE_PATH,jdbcType=VARCHAR},
					#{FILE_ID,jdbcType=VARCHAR},
 					'0',
 					'0'
 				)
 		</insert>
 		<!-- 修改结题报告 -->
 		<update id="updateAchieve" parameterMap="BaseParameterMap">
 			update SC_EXPLORE_ACHIEVE
			set 
				USER_WORK=#{USER_WORK},
				PUBLISH_TITLE=#{PUBLISH_TITLE},
				PUBLISH_SORT=#{PUBLISH_SORT},
				PERIODICALS_FLAG=#{PERIODICALS_FLAG},
				PERIODICALS_NAME=#{PERIODICALS_NAME,jdbcType=VARCHAR},
				<if test="PERIODICALS_DATE != null and PERIODICALS_DATE !='' ">
		  		PERIODICALS_DATE=to_date(#{PERIODICALS_DATE},'yyyy-MM-dd'),
		  		</if>
				PERIODICALS_NUMBER=#{PERIODICALS_NUMBER,jdbcType=VARCHAR},
				WORK_DESCRIBE=#{WORK_DESCRIBE},
				FINAL_REPORT=#{FINAL_REPORT},
				RES_FILE_LINK_PK=#{RES_FILE_LINK_PK,jdbcType=VARCHAR},
				FILE_NAME=#{FILE_NAME,jdbcType=VARCHAR},
				EXT_NAME=#{EXT_NAME,jdbcType=VARCHAR},
				FILE_PATH=#{FILE_PATH,jdbcType=VARCHAR},
				FILE_ID=#{FILE_ID,jdbcType=VARCHAR}
		where EXPLORE_ACHIEVE_PK=#{EXPLORE_ACHIEVE_PK}	
 		</update>
 		
 		
 		<!-- 新增结题报告文件-->
 		<insert id="insertAchieveFile" parameterMap="BaseParameterMap">
 			insert into SC_EXPLORE_ACHIEVE_DOCUMENT
 				(	
					DOCUMENT_PK,
					DOCUMENT_SEQUENCE,
					DOCUMENT_NAME,
					DOCUMENT_NUMBER,
					FK_EXPLORE
 				)
 			values
 				(
 					#{UUID},
 					#{DOCUMENT_SEQUENCE},
 					#{DOCUMENT_NAME},
 					#{DOCUMENT_NUMBER},
 					#{SC_EXPLORE_PK}		
 				)
 		</insert>
 		
 		<!--通过科研主键查询结题报告文件  -->
 		<select id="findFileListBypk" resultMap="BaseResultMap" parameterMap="BaseParameterMap">
 			select 
 				*
			from SC_EXPLORE_ACHIEVE_DOCUMENT
			where FK_EXPLORE=#{EXPLORE_PK}	
			and DELETE_FLAG=0	
 		</select>
 	
 		<!--删除结题报告文件  -->		
	 	<update id="deleteFile" parameterMap="BaseParameterMap">
	 		update SC_EXPLORE_ACHIEVE_DOCUMENT
				set 
					DELETE_FLAG=1
			where DOCUMENT_PK=#{DOCUMENT_PK}
			and FK_EXPLORE=#{SC_EXPLORE_PK}	
	 	</update>	
 		
 		<!-- 修改研究成员的工作承担信息 -->
 		<update id="updateMemeberInfo" parameterMap="BaseParameterMap">
 			update SC_MEMBER
 			set TEACHER_WORK=#{TEACHER_WORK,jdbcType=VARCHAR}
 			where MEMBER_PK=#{MEMBER_PK}
 		</update>

</mapper>